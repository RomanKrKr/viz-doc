# Пропускная способность

**Примечание: пропускная способность измерятся в байт/shares.**



Большинство блокчейн проектов заставляют пользователей платить за каждую операцию, чтобы ограничить спам и сделать его экономически невыгодным. Но VIZ не заставляет пользователей платить, он используют систему динамичного [частичного резервирования](#diff).  При этой модели блокчейн автоматически подбирает коэффициент резервирования при разной нагрузке. Каждый раз когда происходит всплеск активности, блокчейн резко понижает пропускную способность каждого аккаунта. Когда всплеск окончен, и в пропускном канале сети освободилось место, блокчейн медленно увеличивает пропускную способность каждого пользователя.



Каждый раз когда пользователь подписывает транзакцию, она учитывается в его скользящей средней пропускной способности. Если скользящая пересекла лимит, то блокчейн не даст отправить эту транзакцию. В таком случае, транзакцию надо отложить, пока скользящая не опуститься ниже порогового значения.

<div id="diff"></div>

## Чем отличается частичное резервирование от полного

Давайте представим, что в VIZ используется система полного резервирования. Это значит, что каждый пользователь может использовать часть пропускного канала пропорционально его доли в сети. Но невозможно использовать блокчейн в одно и то же время, кроме того не все будут полностью использовать свою пропускную способность. Следовательно, большая часть пропускного канала не будет задействована, а сеть не сможет использовать весь потенциал.



При частичном резервировании каждый отдельный пользователь может использовать больше пропускной способности, когда в сети не происходят активные транзакции. И меньшею во время пиковых нагрузок. В то же время блокчейн будет использовать полное резервирование, если его будут использовать все аккаунты одновременно. Основная сложность такой модели состоит в выборе коэффициента резервирования при разной нагрузки. Если для полного резервирования можно выставить коэффициент, равный 1, то для других ситуаций может быть множество решений. В следующей главе описано, как работает распределение пропускной способности в VIZ.



## Как рассчитывается пропускная способность в VIZ

Перед тем как читать дальше обратите внимание на таблицу условных обозначений ниже.

| Условное обозначение | Единица измерения | Описание |
| -------------------- | ----------------- | ---------------- |
| Bnew                 | байт/shares       | Новое значение скользящей средней для пропускной способности аккаунта |
| Bold                 | байт/shares       | Последнее значение скользящей средней для пропускной способности аккаунта |
| N                    | байт              | Размер новой транзакции                                      |
| W                    | секунды           | Количество секунд в неделе                                   |
| T                    | секунды           | Разница между временем, когда была отправлена последняя транзакция и в данный момент |
| R                    | процент(%)        | [Процент зарезервированный для аккаунтов с малой долей в сети](./witnesses.html#bandwidth_reserve_below). Этот параметр устанавливают делегаты |
| C                    | целое число       | Число активных аккаунтов(отправляли хотя бы одну транзакцию за 30 дней) с малой долей сети |
| Smax                 | Shares            | Объем доли конкретного аккаунта                              |
| S                    | Shares            | Объем доли конкретного аккаунта с учетом процента, зарезервированного для аккаунтов с мелкой долей сети. |
| M                    | Shares            | Объем доли всех аккаунтов                                    |
| G                    | байт              | [Максимальный размер блока](./witnesses.html#maximum_block_size). Это параметр устанавливается делегатами |
| K                    | целое число       | Коэффициент резервирования пропускной способности от 1 до 2000 |
| L                    | целое число       | Количество блоков, которое будет сгенерированно за неделю    |
| E                    | байт/shares       | ``G * L * K`` - максимальная пропускная способность при данной нагрузке |

**Примечание: значение R устанавливают делегаты, они же определяют какой объем доли считать малым. Кроме того, делегаты могут запретить отправлять транзакции для участников с малым объемом доли.**



Для каждого конкретного аккаунта устанавливается лимит пропускной способности ``(S / M) * Е``, то есть пропорционально его доли в  сети. Причем, ``S = Smax * (100% - R)`` , если ``Smax`` считается нормальной, и  ``S = M * R / C``, это значит, что оn аккаунтов с достаточным стеком отнимается часть пропускной способности и распределяется среди аккаунтов с малой долей в сети. Если зарезервированное значение превысит ``Bnew``, то аккаунт не сможет отправить новую транзакцию. В свою очередь, ``Bnew`` вычисляется по следующей формуле:

``Bnew = MAX(0, (W - T) * Bold / W) + N``.

### Как VIZ определяет коэффициент резервирования

Каждый раз когда значение скользящего среднего размера блока больше чем 25% от максимального размера блока ``G``, блокчейн уменьшает ``К`` в два раза. Когда нагрузка спала, блокчейн снова увеличивает ``K``, прибавляя единицу каждую минуту. Такой подход гарантирует, что аккаунты, которые использовали меньше 50% от личного лимита, не будут задеты, если нагрузку не вызвали держатели очень большого стека.



Формула расчета нового значения средней скользящей для размера блока: 

``Anew = (99 * Aold + Q) / 100``

| Условное обозначение | Единица измерения | Описание |
| -------------------- | ----------------- | ----------------- |
| Anew                 | байт              | Новое значение скользящей средней для размера блока     |
| Aold                 | байт              | Последнее значение скользящей средней для размера блока |
| Q                    | байт              | Размер нового блока                                     |

**Примечание: Если коэффициент резервирования постоянно падает ниже 100, то делегаты должны задуматься об увеличении пропускной способности сети, например увеличив максимальный размер блока.**